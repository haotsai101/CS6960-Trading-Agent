# Module 5: Alerts & Attention

## Purpose

Alerts & Attention is the portfolio manager's proactive intelligence system. It answers: "What needs my attention right now, before I go looking for it?" The goal is to **push** critical information to the PM, reducing cognitive overload across 247 positions.

This module is both a standalone tab and a data source for the alert preview in Module 1 (Weekly Review).

---

## 5.1 Category Filter Cards

**Visual**: Five clickable cards across the top, one per alert category. Each shows an icon, count, and label. Clicking a card filters the alert feed below to that category only. Clicking again clears the filter.

| Category | Icon | Color | Description |
|----------|------|-------|-------------|
| Position Size | ◆ | Red (`#C8220D`) | Weight limits and drift |
| Factor Breach | ◇ | Purple (`#6B21A8`) | Factor exposure thresholds |
| Drawdown | ▾ | Amber (`#A85D00`) | Loss thresholds |
| Correlation | ⬡ | Cyan (`#0E7490`) | Concentration via correlation |
| Earnings / Macro | ◈ | Blue (`#1D4ED8`) | Events calendar |

The count on each card = number of active alerts in that category.

---

## 5.2 Alert Feed

**Visual**: Full-width chronological list of all active alerts (or filtered by category). Each alert card contains:

- **Left border**: 4px solid in severity color.
- **Icon**: Category-specific icon.
- **Severity badge**: `HIGH` / `MED` / `LOW` / `INFO` with color-coded background.
- **Category label**: e.g., "Position Size".
- **Message**: Full alert text.
- **Ticker badge** (optional): If the alert references a specific position.
- **Timestamp**: When the alert was generated or is relevant.

### Severity Levels

| Severity | Color | Background | Meaning |
|----------|-------|------------|---------|
| `high` | Red (`#C8220D`) | `#FDF0EE` | Requires immediate action |
| `med` | Amber (`#A85D00`) | `#FFF7EB` | Review within the session |
| `low` | Gray (`#4E5D73`) | `#F3F5F7` | Monitor, no immediate action |
| `info` | Blue (`#1D4ED8`) | `#EBF0FF` | Informational, awareness only |

---

## 5.3 Alert Generation Rules

Each alert type has a specific trigger condition, message template, and severity assignment. Alerts are generated by a **nightly batch job** (for slow-moving conditions) and **intraday checks** (for market-driven triggers).

### 5.3.1 Position Size Alerts

**Trigger**: A position's weight exceeds a threshold relative to the hard cap.

| Condition | Severity | Message Template |
|-----------|----------|-----------------|
| `weight >= max_position_weight` | `high` | `{TICKER} at {weight}% — exceeds {cap}% hard cap. Immediate trim required.` |
| `weight >= max_position_weight * 0.80` | `high` | `{TICKER} at {weight}% — approaching {cap}% hard cap. Trim ${amount} to target {target}%.` |
| `weight_drift >= 0.5%` from entry weight AND `pnl >= 30%` | `med` | `{TICKER} up {pnl}% — weight drifted from {entry_weight}% to {current_weight}%.` |

**Data sources**:
- `positions.weight` (current) vs `portfolio_settings.max_position_weight`
- `positions.entry_weight` (weight at time of purchase) vs current weight
- `positions.pnl_pct`

**Trim amount calculation**: `trim_dollar = (current_weight - target_weight) / 100 * NAV`.

### 5.3.2 Factor Breach Alerts

**Trigger**: Portfolio-level factor exposure exceeds the configured ceiling.

| Condition | Severity | Message Template |
|-----------|----------|-----------------|
| `|factor_exposure| > factor_ceiling` | `high` | `{Factor} factor at {exposure}σ — above {ceiling}σ threshold.` |
| `|factor_exposure| > factor_ceiling * 0.80` | `med` | `{Factor} factor at {exposure}σ — nearing {ceiling}σ ceiling.` |

**Data sources**:
- `factor_exposures` (portfolio-level, updated nightly)
- `portfolio_settings.factor_ceiling`

### 5.3.3 Drawdown Alerts

**Trigger**: A position or sector has drawn down significantly from its cost basis or recent peak.

| Condition | Severity | Message Template |
|-----------|----------|-----------------|
| Sector weekly return < `drawdown_trigger` | `high` | `{Sector} sector {return}% this week. Approaching {trigger}% review trigger.` |
| Position P&L from cost < `stop_loss * 0.75` | `low` | `{TICKER} down {pnl}% from cost — not yet at {stop}% stop.` |
| Position P&L from cost < `stop_loss` | `high` | `{TICKER} hit {stop}% stop loss at {pnl}%. Execute exit or override.` |

**Data sources**:
- `positions.pnl_pct` (from cost basis)
- Sector-level weekly return (aggregated from position returns)
- `portfolio_settings.stop_loss_default`, `portfolio_settings.drawdown_trigger`

### 5.3.4 Correlation Alerts

**Trigger**: Pairwise correlation between held positions is high, creating hidden concentration.

| Condition | Severity | Message Template |
|-----------|----------|-----------------|
| Pairwise corr > `correlation_flag` AND combined weight > 5% | `med` | `{TICKER1}–{TICKER2} 90d corr at {corr} — combined {weight}% weight.` |
| Average intra-sector correlation increased > 10% month-over-month | `low` | `{Sector} internal correlation rising: {current} avg (was {prior}).` |

**Data sources**:
- `correlation_matrix` (90-day rolling, computed nightly)
- `positions.weight` (for combined weight calculation)
- `portfolio_settings.correlation_flag`

### 5.3.5 Earnings & Macro Alerts

**Trigger**: Calendar-based events affecting held positions.

| Condition | Severity | Message Template |
|-----------|----------|-----------------|
| Held position has earnings within 7 calendar days | `info` | `{count} positions reporting next week: {ticker_list}.` |
| Major macro event within 7 calendar days | `info` or `med` | `{Event} on {date}. Portfolio sensitivity: {impact_description}.` |

**Macro events with `med` severity**: Events where the portfolio has outsized exposure (e.g., CPI print when energy weight is 2× benchmark, or Fed meeting when portfolio has high rate sensitivity).

**Data sources**:
- `earnings_calendar` (ticker, report_date) joined with `positions`
- `macro_events` (event_name, event_date, impact_type)
- Sector weights for contextual sensitivity assessment

---

## 5.4 Severity Summary

**Visual**: Small panel showing the count of alerts at each severity level.

| Severity | Label | Count |
|----------|-------|-------|
| High | Critical | 3 |
| Med | Warning | 4 |
| Low | Monitor | 2 |
| Info | Info | 2 |

**Computation**: `GROUP BY severity, COUNT(*)`.

---

## 5.5 This Week's Focus

**Visual**: A prioritized numbered list of the top 5 actions the PM should consider this week. This is a curated synthesis of the most impactful alerts, not a raw feed.

### Generation Logic

1. Take all `high` severity alerts.
2. Condense related alerts into a single action item (e.g., multiple position size alerts → "Review top-heavy positions").
3. Sort by potential portfolio impact (position weight × urgency).
4. Limit to 5 items.

**Examples**:
- "Trim NVDA before it hits 5% hard cap"
- "Review UNH thesis — regulatory headwinds"
- "Energy sector 2× overweight vs benchmark"
- "5 earnings reports next week — size exposure"
- "Monitor tech correlation creep (0.68 avg)"

### Backend Computation

```
GET /api/alerts/focus?limit=5

Response:
{
  items: [
    { priority: number, text: string }
  ]
}
```

---

## 5.6 Threshold Settings Reference

**Visual**: Read-only display of the current alert thresholds, pulled from `portfolio_settings`. This gives the PM visibility into what triggers alerts without needing to navigate to a settings page.

| Setting | Current Value |
|---------|--------------|
| Max position | 5% |
| Max sector OW | ±5% vs bench |
| Factor ceiling | ±1.0σ |
| DD trigger | −5% |
| Corr flag | ≥0.75 |
| Stop loss | −8% |

In a future version, these could become editable inline.

---

## Backend Computation — Full Alert Feed

```
GET /api/alerts?category=&severity=

Response:
{
  alerts: [
    {
      id: string,
      category: "Position Size" | "Factor Breach" | "Drawdown" | "Correlation" | "Earnings" | "Macro",
      severity: "high" | "med" | "low" | "info",
      message: string,
      ticker: string | null,
      timestamp: string,
      icon: string
    }
  ],
  counts_by_category: {
    "Position Size": number,
    "Factor Breach": number,
    "Drawdown": number,
    "Correlation": number,
    "Earnings": number
  },
  counts_by_severity: {
    high: number,
    med: number,
    low: number,
    info: number
  }
}
```

---

## Alert Lifecycle

| Phase | Timing | Description |
|-------|--------|-------------|
| **Generation** | Nightly batch + intraday | Rules engine evaluates all conditions against current data |
| **Persistence** | `alert_instances` table | Each generated alert is stored with a unique ID |
| **Deduplication** | On generation | Don't create a new alert if an identical active alert exists |
| **Resolution** | When condition clears | Alert is marked `resolved` when the triggering condition is no longer true |
| **Expiry** | 7 days after resolution | Resolved alerts are archived after 7 days |

---

## Database Tables Involved

- `alert_rules` — Rule definitions with condition type, thresholds, severity, and message templates
- `alert_instances` — Generated alert records (id, rule_id, category, severity, message, ticker, timestamp, status)
- `portfolio_settings` — All threshold values
- `positions` — For position size and drawdown checks
- `factor_exposures` — For factor breach checks
- `correlation_matrix` — For correlation checks
- `earnings_calendar` — For earnings alerts
- `macro_events` — For macro alerts
- `securities` (sector) — For sector-level aggregations

---

## Frontend State

| State Variable | Type | Default | Controls |
|----------------|------|---------|----------|
| `alertCat` | `string` | `""` | Category filter (empty = show all) |
